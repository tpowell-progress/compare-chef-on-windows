# Chef Version Testing with Windows Docker Containers

This project sets up Windows Docker containers with Windows Server Core 2022 and tests different Chef versions (18.8.11 vs 18.8.46) by installing them via Omnitruck and running a test recipe.

## Prerequisites

- Windows 10/11 or Windows Server with Docker Desktop installed
- Docker configured for Windows containers
- PowerShell 5.1 or later

## Project Structure

```
.
+-- Dockerfile                          # Windows Server Core 2022 with Chef installation
+-- docker-compose.yml                  # Multi-container setup for both Chef versions
+-- run-test.ps1                        # Main test script
+-- cookbooks/
    +-- test_recipe/
        +-- metadata.rb                 # Recipe metadata
        +-- recipes/
            +-- default.rb              # Test recipe that outputs Chef version
+-- shared/                             # Mounted volume for output files
    +-- chef-{version}.txt              # Generated by containers
```

## Quick Start

### Option 1: Using the PowerShell Script (Recommended)

Run the main test script with default versions:

```powershell
.\run-test.ps1
```

Or specify custom Chef versions:

```powershell
.\run-test.ps1 -ChefVersion1 "18.8.11" -ChefVersion2 "18.8.46"
```

### Option 2: Using Docker Compose

```powershell
# Build both images
docker-compose build

# Run both containers
docker-compose up

# Check results
Get-ChildItem .\shared\chef-*.txt | ForEach-Object { Write-Host "=== $($_.Name) ==="; Get-Content $_ }
```

### Option 3: Manual Docker Commands

```powershell
# Create shared directory
New-Item -ItemType Directory -Path .\shared -Force

# Build and run Chef 18.8.11
docker build --build-arg CHEF_VERSION=18.8.11 -t chef-test:18.8.11 .
docker run --rm -v "${PWD}\shared:C:\shared" -v "${PWD}\cookbooks:C:\cookbooks" chef-test:18.8.11 powershell -Command "chef-client -z -o recipe[test_recipe] --chef-license accept-silent"

# Build and run Chef 18.8.46
docker build --build-arg CHEF_VERSION=18.8.46 -t chef-test:18.8.46 .
docker run --rm -v "${PWD}\shared:C:\shared" -v "${PWD}\cookbooks:C:\cookbooks" chef-test:18.8.46 powershell -Command "chef-client -z -o recipe[test_recipe] --chef-license accept-silent"

# Check results
Get-ChildItem .\shared\chef-*.txt | ForEach-Object { Get-Content $_ }
```

## What the Script Does

1. **Creates Shared Volume**: Sets up a directory for output files
2. **Builds Docker Images**: Creates Windows Server Core 2022 images with specified Chef versions installed via Omnitruck
3. **Runs Containers**: Executes Chef client in zero mode with the test recipe
4. **Searches for Chef.PowerShell.Wrapper.dll**: Before running Chef recipes, the script searches for this DLL and outputs location, size, and timestamp
5. **Test Recipe Execution**: The recipe runs a PowerShell script that:
   - Retrieves the current Chef version
   - Searches for Chef.PowerShell.Wrapper.dll
   - Outputs version and DLL information to a file on the shared volume
   - File is named `chef-{version}.txt`
6. **Validates Results**: Checks the shared volume for both output files and displays their contents

## Output Files

Each container generates a file named `chef-{version}.txt` in the `shared` directory containing:

- Chef version
- Computer name (container name)
- Timestamp
- Chef client path
- Chef.PowerShell.Wrapper.dll search results (path, size, last write time)

Example output file content:

```
Chef Version: 18.8.11
Computer Name: CONTAINER123
Timestamp: 2025-10-22 10:30:45
Chef Client Path: C:\opscode\chef\bin\chef-client

Chef.PowerShell.Wrapper.dll Search Results:
  Path: C:\opscode\chef\embedded\lib\ruby\gems\3.1.0\gems\chef-18.8.11\lib\Chef.PowerShell.Wrapper.dll
  Size: 12345 bytes
  LastWriteTime: 10/22/2025 10:15:30
```

## Troubleshooting

### Docker is in Linux mode

Switch Docker to Windows containers:

```powershell
& $Env:ProgramFiles\Docker\Docker\DockerCli.exe -SwitchDaemon
```

### Build fails with network errors

Ensure you have internet access and TLS 1.2 is enabled:

```powershell
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
```

### Containers fail to start

Check Docker is running and Windows containers are available:

```powershell
docker info
docker version
```

## Customization

To test different Chef versions, modify the `run-test.ps1` parameters or update `docker-compose.yml`:

```yaml
args:
  CHEF_VERSION: "17.10.0"  # Change to desired version
```

## Cleanup

Remove generated images and containers:

```powershell
# Remove containers
docker-compose down

# Remove images
docker rmi chef-test:18.8.11 chef-test:18.8.46

# Clean shared directory
Remove-Item .\shared\chef-*.txt
```
