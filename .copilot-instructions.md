# Copilot Instructions for Chef Windows Testing Project

## Project Context
This project compares Chef Infra Client installations across different versions on Windows using Docker containers. The main focus is analyzing DLL dependencies, installation methods (MSI vs Omnitruck), and Chef PowerShell wrapper behavior.

## Code Quality Standards

### Script Testing
- **Always test scripts after creation or modification** using `run_in_terminal`
- **Verify syntax** by running PowerShell parsing checks
- **Check for runtime errors** in initial execution
- **Validate core functionality** where possible
- For long-running scripts (Docker builds), verify they start without syntax errors

### PowerShell Best Practices
- Use `${VariableName}` syntax when variables are followed by colons or special characters
- Include error handling with try-catch blocks where appropriate
- Use `-ErrorAction SilentlyContinue` for optional operations
- Add `-Force` parameters for file operations that might encounter existing files
- Include progress indicators with `Write-Host` and color coding

### Docker Integration
- Use proper build argument handling: `ARG` + `ENV` for runtime access
- Include `--rm` flag for temporary containers
- Mount volumes consistently: `-v "${PWD}\shared:C:\shared"`
- Use meaningful image tags that include version numbers
- Handle Docker build failures gracefully

### File Naming Conventions
- Use timestamps in output files: `yyyyMMdd-HHmmss` format
- Include version numbers in filenames: `chef-{version}-{timestamp}.txt`
- Use descriptive prefixes: `compare-`, `run-`, `analyze-`
- Maintain consistent extensions: `.ps1` for PowerShell, `.txt` for output

## Project-Specific Requirements

### Chef Version Testing
- Support both MSI and Omnitruck installation methods
- Include Chef license acceptance: `CHEF_LICENSE=accept-silent`
- Set proper PATH for Chef PowerShell wrapper components
- Handle version extraction from MSI filenames using regex

### DLL Analysis
- Scan recursively under `C:\opscode` for DLL files
- Capture file size, timestamp, and relative path
- Support both dumpbin dependency analysis and file system scanning
- Compare DLL states before/after operations

### User Experience
- Include sound notifications for completion (success/failure beeps)
- Provide colored console output for status indication
- Offer interactive container access for debugging failures
- Generate comprehensive reports with summaries

### Error Handling
- Continue execution when non-critical operations fail (VS Build Tools)
- Provide fallback behavior when tools are unavailable (dumpbin)
- Clean up temporary files even on failure
- Give clear error messages with suggested actions

## File Structure Expectations
```
├── run-test.ps1           # Main comprehensive testing script
├── run-simple-test.ps1    # Simplified testing without diagnostics
├── compare-chef-dlls.ps1  # Version comparison utility
├── Dockerfile             # Omnitruck installation container
├── Dockerfile.msi         # MSI installation container
├── shared/                # Output directory for results
├── cookbooks/test_recipe/ # Chef recipe for testing
└── .dockerignore          # Minimize build context
```

## Common Patterns

### Container Debugging
When operations fail, provide interactive container access:
```powershell
docker run --rm -it \
    -e CHEF_LICENSE=accept-silent \
    -v "${PWD}\shared:C:\shared" \
    -v "${PWD}\cookbooks:C:\cookbooks" \
    chef-test:$imageTag \
    powershell
```

### Version Extraction
Extract version numbers from filenames:
```powershell
if ($msiPath -match 'chef-(\d+\.\d+\.\d+)') {
    $extractedVersion = $matches[1]
}
```

### Timestamped Output
Always include timestamps in output files:
```powershell
$fileTimestamp = Get-Date -Format 'yyyyMMdd-HHmmss'
$outputFile = "C:\shared\chef-$chefVersion-$fileTimestamp.txt"
```

### Sound Feedback
Provide audio completion feedback:
```powershell
function Play-CompletionSound {
    param([bool]$Success)
    if ($Success) {
        [Console]::Beep(800, 200); [Console]::Beep(1000, 200); [Console]::Beep(1200, 200)
    } else {
        [Console]::Beep(400, 300); [Console]::Beep(200, 300)
    }
}
```

## Testing Checklist
When creating or modifying scripts:
- [ ] Syntax validation (run script to check for parse errors)
- [ ] Parameter validation (required parameters, file existence)
- [ ] Docker integration (build args, environment variables)
- [ ] Error handling (graceful failures, cleanup)
- [ ] Output generation (timestamped files, proper encoding)
- [ ] User feedback (progress messages, completion sounds)
- [ ] Documentation (help text, parameter descriptions)

## Dependencies
- Docker Desktop for Windows containers
- PowerShell 5.1 or later
- Windows Server Core ltsc2022 base images
- Chef Infra Client MSI files or Omnitruck access
- Visual Studio Build Tools (optional, for dumpbin)